name: ZAP Active Scan

on:
  workflow_call:
    secrets:
      ZAP_API_KEY:
        required: true

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    continue-on-error: true

    env:
      ZAP_API: "https://zapscan.seliselocal.com"
      ZAP_KEY: ${{ secrets.ZAP_API_KEY }}
      TARGET: "https://dev-api.seliseblocks.com"
      REPORT_FILE: "zap-report.xml"

    steps:
      - name: Create new session
        run: |
          echo "Creating new ZAP session..."
          curl "$ZAP_API/JSON/core/action/newSession/?apikey=$ZAP_KEY&name=dev-api&overwrite=true" > /dev/null || true

      - name: Access target URL
        run: |
          echo "Accessing target URL to populate ZAP session..."
          curl "$ZAP_API/JSON/core/action/accessUrl/?apikey=$ZAP_KEY&url=$TARGET&followRedirects=" > /dev/null || true
          curl "$ZAP_API/JSON/core/view/sites/?apikey=$ZAP_KEY" || true
 
      - name: Start Scan
        id: start-scan
        run: |
          echo "Starting active scan..."
          SCAN_ID=$(curl -s "$ZAP_API/JSON/ascan/action/scan/?url=$TARGET&recurse=true&inScopeOnly=false&apikey=$ZAP_KEY" | jq -r '.scan' || true)
          # curl -s "$ZAP_API/JSON/ascan/action/scan/?url=$TARGET&recurse=true&inScopeOnly=false&apikey=$ZAP_KEY"

          echo "Scan ID: $SCAN_ID"
          echo "SCAN_ID=$SCAN_ID" >> $GITHUB_ENV

      - name: Wait until scan is finished
        run: |
          echo "Waiting for scan to reach 100%..."
          while true; do
            STATUS=$(curl -s "$ZAP_API/JSON/ascan/view/status/?scanId=${SCAN_ID}&apikey=$ZAP_KEY" | jq -r '.status' || true)
            echo "Scan progress: $STATUS%"

            if [ "$STATUS" = "100" ] || [ -z "$STATUS" ]; then
              echo "Scan Completed!"
              break
            fi
            sleep 15
          done

      - name: Download xml Report
        run: |
          echo "Downloading Report..."
          curl -s "$ZAP_API/OTHER/core/other/xmlreport/?apikey=$ZAP_KEY" -o "$REPORT_FILE" || true

      - name: Compute ZAP severity counts
        if: always()
        shell: bash
        run: |
          if [ ! -f "$REPORT_FILE" ]; then
            echo "Error: $REPORT_FILE not found in $(pwd)"
            exit 0
          fi

          echo "Report found, computing severities..."
          ZAP_HIGH=$(grep -c "<riskcode>3</riskcode>" "$REPORT_FILE" || true)
          ZAP_MEDIUM=$(grep -c "<riskcode>2</riskcode>" "$REPORT_FILE" || true)
          ZAP_LOW=$(grep -c "<riskcode>1</riskcode>" "$REPORT_FILE" || true)
          ZAP_INFO=$(grep -c "<riskcode>0</riskcode>" "$REPORT_FILE" || true)
          ZAP_TOTAL=$((ZAP_HIGH + ZAP_MEDIUM + ZAP_LOW + ZAP_INFO))

          {
            echo "ZAP_HIGH=${ZAP_HIGH}"
            echo "ZAP_MEDIUM=${ZAP_MEDIUM}"
            echo "ZAP_LOW=${ZAP_LOW}"
            echo "ZAP_INFO=${ZAP_INFO}"
            echo "ZAP_TOTAL=${ZAP_TOTAL}"
          } > zap-severity.env

          cat zap-severity.env >> "$GITHUB_ENV"
          echo "Severity counts added to GITHUB_ENV"

      - name: Upload Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: ${{ env.REPORT_FILE }}

      - name: DAST Summary
        if: always()
        shell: bash
        run: |
          ZAP_HIGH="${ZAP_HIGH:-n/a}"
          ZAP_MEDIUM="${ZAP_MEDIUM:-n/a}"
          ZAP_LOW="${ZAP_LOW:-n/a}"
          ZAP_INFO="${ZAP_INFO:-n/a}"
          ZAP_TOTAL="${ZAP_TOTAL:-n/a}"
          {
            echo "### DAST (ZAP) Summary"
            echo ""
            echo "- Target: \`${TARGET}\`"
            echo "- ZAP API: \`${ZAP_API}\`"
            echo "- Scan ID: \`${SCAN_ID:-unknown}\`"
            echo "- Report: \`$REPORT_FILE\`"
            echo "- Artifact: \`zap-report\`"
            echo "- Findings: high \`${ZAP_HIGH}\`, medium \`${ZAP_MEDIUM}\`, low \`${ZAP_LOW}\`, info \`${ZAP_INFO}\` (total \`${ZAP_TOTAL}\`)"
          } >> "$GITHUB_STEP_SUMMARY"
